<!DOCTYPE html>
<html>
    <head>
        <!-- Benchmark function imports -->
        <script src="Bezier.js"></script>
        <script src="CirclesRandomSize.js"></script>
        <script src="CirclesUniformSize.js"></script>
        <script src="FillText.js"></script>
        <script src="ImageMark.js"></script>
        <script src="StaticAsteroids.js"></script>
        <script src="IsPointInPath.js"></script>
        <script src="MeasureText.js"></script>
        <script src="Rave.js"></script>
        <!-- Benchmark execution and timing -->
        <script>
            var os;
            var browser;
            var times = [];
            var total = 0;
            var output_csv = ["Name,Mean"];

            function main() {
                // get system information
                var nAgent = navigator.userAgent;
                if (nAgent.indexOf("Firefox") != -1) {
                    browser = "Firefox";
                } else if (nAgent.indexOf("Chrome") != -1) {
                    browser = "Chrome";
                } else if (nAgent.indexOf("Safari") != -1) {
                    browser = "Safari";
                } else {
                    browser = "UnknownBrowser";
                }

                if (nAgent.indexOf("Linux") != -1) {
                    os = "Linux";
                } else if (nAgent.indexOf("Mac") != -1) {
                    os = "OSX";
                } else {
                    os = "UnknownOS";
                }

                var canvas = document.getElementById("cnv");
                var context = canvas.getContext("2d");
                canvas.width = 800;  // window.innerWidth;
                canvas.height = 600; // window.innerHeight;
                var functions = [
                    Bezier,
                    CirclesRandomSize,
                    CirclesUniformSize,
                    FillText,
                    ImageMark,
                    StaticAsteroids,
                    IsPointInPath,
                    MeasureText,
                    Rave,
                ];

                time(functions, 100, context);
            }

            // execute benchmark functions, time
            function time(functions, trials, context) {
                // build a recursive stack of rendering calls separated by timeouts
                (function loop(trials, trial, functions, func_num, context) {
                    setTimeout(function() {
                        if (trial != 0 && func_num < functions.length) {
                            // get time, store in times array
                            var start = new Date().getTime();
                            var k = functions[func_num](1000, context);
      	                    if (typeof k != "function") {
      	                        k = function(r) { 
                                    r(); 
                                }
      	    		        }
      	                    k(function() {
      	                        var end = new Date().getTime();
                                times[trials - trial] = end - start;
                                loop(trials, trial - 1, functions, func_num, context);
      	                    });
                        } else if (trial == 0 && func_num < functions.length) {
                            // at the end of the stack, find the average                           
                            for (j = 0; j < trials; j++) {
                                total += times[j];
                            }

                            output_csv.push(functions[func_num].name + "," + total / trials);
                            
                            loop(trials, trials, functions, func_num + 1, context);
                        } else if (func_num == functions.length) {
                            // create output csv file 
                            var csvString = output_csv.join("\r\n");
                            var a = document.createElement("a");
                            
                            a.href = 'data:attachment/csv;charset=utf-8,' + escape(csvString);
                            a.target = '_blank';
                            a.download = os + "-" + browser + "-JavaScript.csv";
                            a.innerHTML = "Click to download file.";
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        } else
                            return;
                        }, 0);
                })(trials, trials, functions, 0, context);
            }
        </script>
        <style>
            body {
                margin: 0px;
                padding: 0px;
            }
            img {
                visibility: hidden;
            }
        </style>
    </head>
    <body onload="main()">
        <canvas id="cnv" width="100" height="100"></canvas>
    </body>
</html>
